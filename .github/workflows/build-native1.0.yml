name: Build Native Image (Optimized)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    # 1. 配置 GraalVM 环境
    - name: Setup GraalVM
      uses: graalvm/setup-graalvm@v1
      with:
        java-version: '21'
        distribution: 'graalvm'
        github-token: ${{ secrets.GITHUB_TOKEN }}
        native-image-job-reports: 'true'

    # 2. 缓存 Maven 依赖
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    # ========================================================
    # 3. 【完美修复】下载并安装 telegram4j 依赖 (使用新地址)
    # ========================================================
    - name: Install telegram4j dependency manually
      run: |
        echo "正在从新官方仓库拉取 telegram4j..."
        # 使用新的有效地址，并指定 main 分支 (防止 default branch 差异)
        git clone https://github.com/Telegram4J/Telegram4J.git temp-telegram
        
        echo "正在本地编译安装..."
        cd temp-telegram
        
        # 强制修正版本号 (防止源码版本号变动导致不匹配)
        # alist-tvbox 需要 0.1.0-SNAPSHOT，确保 pom.xml 里是这个
        mvn versions:set -DnewVersion=0.1.0-SNAPSHOT
        
        # 编译并安装到本地 Maven 仓库
        mvn clean install -DskipTests -Dmaven.javadoc.skip=true -Dmaven.source.skip=true
        
        echo "依赖安装成功！"
        cd ..
        rm -rf temp-telegram

    # 4. 安装 UPX 压缩工具
    - name: Install UPX
      run: sudo apt-get update && sudo apt-get install -y upx

    # 5. 执行 Native 编译 (保留所有功能)
    - name: Build Native Image
      run: |
        mvn -Pnative native:compile -DskipTests --no-transfer-progress \
          -Dnative-image.buildArgs="--no-fallback"

    # 6. 压缩二进制文件
    - name: Compress with UPX
      run: |
        # 自动查找 target 目录下的二进制文件
        BINARY_PATH=$(find target -maxdepth 1 -type f -executable -not -name "*.sh" | head -n 1)
        
        if [ -z "$BINARY_PATH" ]; then
          echo "Error: 未找到编译产物！"
          exit 1
        fi

        echo "找到产物: $BINARY_PATH"
        upx --best --lzma "$BINARY_PATH"
        mv "$BINARY_PATH" alist-tvbox-linux-amd64

    # 7. 上传构建产物
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: alist-tvbox-native-binary
        path: alist-tvbox-linux-amd64
        retention-days: 90
