name: Build Native Image (Optimized)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch: # 允许手动点击按钮触发

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    # 1. 配置 GraalVM 环境 (Java 21)
    - name: Setup GraalVM
      uses: graalvm/setup-graalvm@v1
      with:
        java-version: '21'
        distribution: 'graalvm'
        github-token: ${{ secrets.GITHUB_TOKEN }}
        native-image-job-reports: 'true'

    # 2. 缓存 Maven 依赖
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    # ========================================================
    # 3. 【关键修复】手动编译安装缺失的 telegram4j 依赖
    # ========================================================
    - name: Install missing telegram4j dependency
      run: |
        echo "正在拉取 telegram4j 源码..."
        git clone https://github.com/Penguin-D/telegram4j.git temp-telegram
        
        echo "正在本地编译安装 telegram4j..."
        cd temp-telegram
        # 强制使用 java 17 兼容性编译，跳过测试
        mvn clean install -DskipTests -Dmaven.javadoc.skip=true
        
        echo "依赖安装完成！清理临时文件..."
        cd ..
        rm -rf temp-telegram

    # 4. 安装 UPX 压缩工具
    - name: Install UPX
      run: sudo apt-get update && sudo apt-get install -y upx

    # 5. 执行 Native 编译
    # 增加 --no-fallback 参数，确保生成纯原生文件，不回退到 JVM 模式
    - name: Build Native Image
      run: |
        mvn -Pnative native:compile -DskipTests --no-transfer-progress \
          -Dnative-image.buildArgs="--no-fallback"

    # 6. 压缩二进制文件 (体积优化)
    - name: Compress with UPX
      run: |
        # 查找 target 下生成的可执行文件 (排除 .jar 和 .txt)
        # 通常文件名是 alist-tvbox
        BINARY_PATH=$(find target -maxdepth 1 -type f -executable -not -name "*.sh" | head -n 1)
        
        echo "找到编译产物: $BINARY_PATH"
        
        # 使用 UPX 极限压缩
        upx --best --lzma "$BINARY_PATH"
        
        # 重命名方便识别
        mv "$BINARY_PATH" alist-tvbox-linux-amd64

    # 7. 上传构建产物
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: alist-tvbox-native-binary
        path: alist-tvbox-linux-amd64
        retention-days: 90
